# Swift to WASM Example: Greet and Add

This example demonstrates how to compile Swift functions to WebAssembly (WASM) using the SwiftWasm toolchain and the `carton` build tool. It shows how to export Swift functions and make them callable from JavaScript in a web browser.

The example exposes two Swift functions:
- `greet(name: String) -> String`: Takes a name and returns a greeting message.
- `add(a: Int, b: Int) -> Int`: Takes two integers and returns their sum.

These functions are made available to JavaScript via an object named `swiftExports` on the `window` global object.

## Files

- `Package.swift`: The Swift Package Manager manifest. It defines the project as an executable, specifies dependencies on `JavaScriptKit` (for JS interop) and `carton` (as a build tool plugin).
- `Sources/SwiftWasmExampleApp/main.swift`: Contains the Swift source code:
    - Definitions for the `greet` and `add` functions.
    - Logic using `JavaScriptKit` (`JSClosure`, `JSObject.global`) to export these functions to the JavaScript environment under `window.swiftExports`.
- `custom_index.html`: A custom HTML page used by `carton` for the bundled application. It provides a simple UI to interact with the exported Swift functions and includes inline JavaScript to call them.
- `build.sh`: A shell script that uses `swift run carton bundle` to:
    - Compile the Swift code to WASM.
    - Package all necessary files (WASM binary, JavaScript loader, our `custom_index.html`) into a `Bundle/` directory.
    - Copies the contents of `Bundle/` into a `dist/` directory for easy serving and consistency.
- `dist/` (Generated by `build.sh`): This directory contains all the files needed to run the example in a browser, including:
    - `index.html` (which is our `custom_index.html`).
    - The compiled Swift WASM module (e.g., `SwiftWasmExampleApp.wasm`).
    - A JavaScript loader file generated by `carton`.

## Prerequisites

1.  **Swift Toolchain**: A recent version of Swift that is compatible with SwiftWasm. As of `carton` 1.0.x, this typically means Swift 5.9.2 or later.
    - On macOS, ensure you have a compatible version of Xcode installed (e.g., Xcode 15.1 or later for Swift 5.9.2). The command line tools should also be selected (`xcode-select`).
    - On Linux, you'll need to install a compatible Swift toolchain from [swift.org/download/](https://swift.org/download/).
2.  **`carton` Installation**: `carton` is included as a package plugin in `Package.swift`, so it doesn't need separate global installation if you use `swift run carton ...`. However, you might need its dependencies like `binaryen` (for `wasm-opt`) if not installed by `carton` automatically. `carton` aims to manage its dependencies.

## How to Build

1.  Navigate to the Swift example directory:
    ```bash
    cd examples/wasm/swift_example
    ```
2.  Make the build script executable (if it isn't already):
    ```bash
    chmod +x build.sh
    ```
3.  Run the build script:
    ```bash
    ./build.sh
    ```
    This script invokes `swift run carton bundle`. It will fetch dependencies, compile your Swift code to WASM, and package everything into the `Bundle/` directory. The script then copies these files to `dist/`.
    The first build might take some time as `carton` may download or build the SwiftWasm SDK.

## How to Run

1.  After successfully building the WASM module (the `dist/` directory is populated, containing an `index.html` and a `.wasm` file), you need to serve the `examples/wasm/swift_example/` directory (or specifically the `dist/` subdirectory) using a local web server.

2.  A simple way to start a web server (if you have Python 3) from the `examples/wasm/swift_example/` directory is:
    ```bash
    python -m http.server
    ```
    Then navigate to `http://localhost:8000/dist/index.html`.

    Alternatively, `cd dist` and run `python -m http.server` from there, then navigate to `http://localhost:8000/`.

3.  Open your web browser. You should see the UI from `custom_index.html`. Interact with the buttons to call the Swift functions. Results will be displayed on the page. Check the browser's developer console for any messages from Swift or JavaScript.

## Notes

-   **`JavaScriptKit`**: This library is crucial for interacting with JavaScript.
    -   `JSClosure`: Wraps Swift closures to make them callable from JavaScript. In this example, it's used to create JS-compatible versions of our Swift functions.
    -   `JSObject.global`: Represents the JavaScript global object (`window`). We use `JSObject.global.swiftExports = ...` to make our Swift functions accessible from JS.
-   **`carton`**: This tool simplifies the build and bundling process significantly.
    -   `swift run carton bundle`: Creates an optimized, distributable package.
    -   `--custom-index-page ./custom_index.html`: Tells `carton` to use our HTML file instead of its default one.
-   **Data Marshalling**: When passing data between Swift and JavaScript:
    -   Strings: `JSValue.string("Swift String")` and `jsValue.string` (which returns an optional `String?`).
    -   Numbers: `JSValue.number(Double(swiftInt))` and `jsValue.number` (which returns an optional `Double?`). Explicit casting (e.g., `Int()`, `Double()`) is often needed.
-   **Entry Point**: The `main.swift` file sets up the exports. `carton` generates the necessary JavaScript to load and run the `.wasm` file.
